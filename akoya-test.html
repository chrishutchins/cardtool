<!DOCTYPE html>
<html>
<head>
  <title>Akoya API Test</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; max-width: 900px; margin: 40px auto; padding: 20px; }
    button { background: #0066cc; color: white; border: none; padding: 12px 24px; font-size: 16px; border-radius: 6px; cursor: pointer; margin: 5px; }
    button:hover { background: #0052a3; }
    pre { background: #1a1a2e; color: #00ff88; padding: 20px; border-radius: 8px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; max-height: 500px; overflow-y: auto; }
    .provider-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; }
    .provider-btn { background: #2d3748; padding: 15px; text-align: center; }
    .provider-btn:hover { background: #4a5568; }
    h1 { color: #333; }
    .instructions { background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .section { margin: 30px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
    input { padding: 10px; font-size: 14px; width: 300px; margin-right: 10px; }
  </style>
</head>
<body>
  <h1>Akoya Connect Test</h1>
  
  <div class="instructions">
    <strong>Instructions:</strong>
    <ol>
      <li>Select a provider (bank) below to connect</li>
      <li>Authenticate with the sandbox credentials</li>
      <li>After redirect, the page will fetch and display your data</li>
    </ol>
    <p><strong>Sandbox credentials:</strong> Usually <code>mikomo / mikomo</code> or check Akoya docs</p>
  </div>

  <div class="section">
    <h2>Step 1: Select a Provider</h2>
    <p>Common sandbox providers:</p>
    <div class="provider-grid">
      <button class="provider-btn" onclick="connect('mikomo')">Mikomo (Test Bank)</button>
      <button class="provider-btn" onclick="connect('chase')">Chase</button>
      <button class="provider-btn" onclick="connect('capitalone')">Capital One</button>
      <button class="provider-btn" onclick="connect('citi')">Citi</button>
      <button class="provider-btn" onclick="connect('amex')">American Express</button>
      <button class="provider-btn" onclick="connect('bankofamerica')">Bank of America</button>
    </div>
    <p>Or enter a provider ID:</p>
    <input type="text" id="custom-provider" placeholder="e.g., mikomo">
    <button onclick="connect(document.getElementById('custom-provider').value)">Connect Custom Provider</button>
  </div>

  <div class="section" id="results-section" style="display:none;">
    <h2>Results</h2>
    <div id="token-info"></div>
    <h3>Accounts</h3>
    <pre id="accounts-result">Loading...</pre>
    <h3>Transactions</h3>
    <pre id="transactions-result">Loading...</pre>
  </div>

  <div class="section">
    <h2>Debug Log</h2>
    <pre id="debug-log">Waiting for action...</pre>
  </div>

  <script>
    const CLIENT_ID = '52d5dc75-98e0-4df4-b1ff-809a2c06a387';
    const REDIRECT_URI = window.location.origin + '/api/akoya/callback';
    const SANDBOX_AUTH_URL = 'https://sandbox-idp.ddp.akoya.com';
    
    function log(msg) {
      const el = document.getElementById('debug-log');
      el.textContent = new Date().toISOString().slice(11, 19) + ' - ' + msg + '\n' + el.textContent;
    }
    
    function connect(providerId) {
      if (!providerId) {
        alert('Please enter a provider ID');
        return;
      }
      
      log('Starting OAuth flow for provider: ' + providerId);
      
      // Build OAuth authorization URL
      const params = new URLSearchParams({
        connector: providerId,
        client_id: CLIENT_ID,
        redirect_uri: REDIRECT_URI,
        response_type: 'code',
        scope: 'openid offline_access',
        state: providerId  // Pass provider in state so callback knows which provider
      });
      
      const authUrl = SANDBOX_AUTH_URL + '/auth?' + params.toString();
      log('Redirecting to: ' + authUrl);
      
      window.location.href = authUrl;
    }
    
    // Check if we're returning from OAuth callback
    async function checkCallback() {
      const urlParams = new URLSearchParams(window.location.search);
      const accounts = urlParams.get('accounts');
      const transactions = urlParams.get('transactions');
      const error = urlParams.get('error');
      const provider = urlParams.get('provider');
      
      if (error) {
        log('Error from callback: ' + error);
        document.getElementById('results-section').style.display = 'block';
        document.getElementById('accounts-result').textContent = 'Error: ' + error + '\n' + urlParams.get('details');
        return;
      }
      
      if (accounts) {
        log('Received data from callback');
        document.getElementById('results-section').style.display = 'block';
        document.getElementById('token-info').innerHTML = '<p><strong>Provider:</strong> ' + (provider || 'unknown') + '</p>';
        
        try {
          document.getElementById('accounts-result').textContent = JSON.stringify(JSON.parse(decodeURIComponent(accounts)), null, 2);
        } catch (e) {
          document.getElementById('accounts-result').textContent = decodeURIComponent(accounts);
        }
        
        if (transactions) {
          try {
            document.getElementById('transactions-result').textContent = JSON.stringify(JSON.parse(decodeURIComponent(transactions)), null, 2);
          } catch (e) {
            document.getElementById('transactions-result').textContent = decodeURIComponent(transactions);
          }
        } else {
          document.getElementById('transactions-result').textContent = 'No transactions returned';
        }
        
        // Clear URL params
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    }
    
    checkCallback();
  </script>
</body>
</html>
